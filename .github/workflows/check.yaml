name: brew tap check

on:
  pull_request:

jobs:
  check:
    if: ${{ startsWith(github.head_ref || '', 'bottle-pr-') == false }}
    runs-on: warp-macos-15-arm64-6x
    permissions:
      actions: read
      checks: read
      contents: read
      pull-requests: read
    steps:
      - name: Configure RunsOn features
        uses: runs-on/action@v2

      - uses: actions/checkout@v6

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ github.token }}

      - name: Cache Homebrew Bundler RubyGems
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ runner.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ runner.os }}-rubygems-

      - run: brew test-bot --only-cleanup-before

      - run: brew test-bot --only-setup

      - name: Skip if cask missing
        id: files
        run: |
          casks=$(ls Casks/*.rb 2>/dev/null || true)
          formulae=$(ls Formula/*.rb 2>/dev/null || true)

          if [ -z "$casks" ] && [ -z "$formulae" ]; then
            echo "nothing_to_check=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "casks=$casks" >> "$GITHUB_OUTPUT"
          echo "formulae=$formulae" >> "$GITHUB_OUTPUT"

      - name: Register tap from checkout
        if: steps.files.outputs.nothing_to_check != 'true'
        run: |
          brew untap weave-labs/tap || true
          brew tap --custom-remote weave-labs/tap "$(pwd)"

      - name: Style
        if: steps.files.outputs.nothing_to_check != 'true'
        run: |
          args=()
          if [ -n "${{ steps.files.outputs.casks }}" ]; then
            args+=( ${{ steps.files.outputs.casks }} )
          fi
          if [ -n "${{ steps.files.outputs.formulae }}" ]; then
            args+=( ${{ steps.files.outputs.formulae }} )
          fi
          brew style "${args[@]}"

      - name: Audit casks (online)
        if: github.event_name == 'pull_request' && steps.files.outputs.casks != ''
        run: brew audit --cask --online ${{ steps.files.outputs.casks }}

      - name: Audit formulae (online)
        if: github.event_name == 'pull_request' && steps.files.outputs.formulae != ''
        run: brew audit --formula --online ${{ steps.files.outputs.formulae }}

      - name: Install casks (smoke)
        if: github.event_name == 'pull_request' && steps.files.outputs.casks != ''
        run: |
          for c in ${{ steps.files.outputs.casks }}; do
            tok=$(basename "$c" .rb)
            brew install --cask "./$c"
            brew uninstall --cask --force "$tok"
          done

  tap-syntax:
    if: ${{ startsWith(github.head_ref || '', 'bottle-pr-') == false }}
    needs: check
    strategy:
      matrix:
        os:
          - warp-macos-13-arm64-6x
          - warp-macos-14-arm64-6x
          - warp-macos-15-arm64-6x
    runs-on: ${{ matrix.os }}
    permissions:
      actions: read
      checks: read
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v6

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ github.token }}

      - name: Cache Homebrew Bundler RubyGems
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ matrix.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ matrix.os }}-rubygems-

      - run: brew test-bot --only-cleanup-before

      - run: brew test-bot --only-setup

      - name: Skip if no tap content
        run: |
          casks=$(ls Casks/*.rb 2>/dev/null || true)
          formulae=$(ls Formula/*.rb 2>/dev/null || true)
          if [ -z "$casks" ] && [ -z "$formulae" ]; then
            echo "no tap content; skipping tap-syntax."
            exit 0
          fi

      - run: brew test-bot --only-tap-syntax
