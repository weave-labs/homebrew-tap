name: brew pr-pull

on:
  workflow_run:
    workflows: ["brew tap check"]
    types: [completed]

jobs:
  publish-bottles:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: homebrew-publish
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write
    steps:
      - name: Extract PR info
        id: pr
        run: |
          payload='${{ toJson(github.event.workflow_run) }}'
          pr=$(jq -r '.pull_requests[0].number // empty' <<< "$payload")
          head_ref=$(jq -r '.pull_requests[0].head.ref // empty' <<< "$payload")
          head_repo=$(jq -r '.pull_requests[0].head.repo.full_name // empty' <<< "$payload")

          if [ -z "$pr" ]; then
            echo "No PR found on workflow_run payload; exiting."
            exit 1
          fi

          echo "pr=$pr" >> "$GITHUB_OUTPUT"
          echo "head_ref=$head_ref" >> "$GITHUB_OUTPUT"
          echo "head_repo=$head_repo" >> "$GITHUB_OUTPUT"

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Pull bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST: ${{ steps.pr.outputs.pr }}
        run: brew pr-pull --debug --tap="$GITHUB_REPOSITORY" "$PULL_REQUEST"

      - name: Push commits
        uses: Homebrew/actions/git-try-push@main
        with:
          branch: main

      - name: Delete branch
        if: steps.pr.outputs.head_repo == github.repository && steps.pr.outputs.head_ref != ''
        env:
          BRANCH: ${{ steps.pr.outputs.head_ref }}
        run: git push --delete origin "$BRANCH"
