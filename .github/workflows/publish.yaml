name: brew pr-pull

on:
  workflow_run:
    workflows: ["brew tap check"]
    types: [completed]

jobs:
  publish-bottles:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: runs-on=${{ github.run_id }}/runner=linux-default
    environment: homebrew-publish
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write
    steps:
      - name: Extract PR info
        id: pr
        run: |
          payload='${{ toJson(github.event.workflow_run) }}'
          pr=$(jq -r '.pull_requests[0].number // empty' <<< "$payload")
          head_ref=$(jq -r '.pull_requests[0].head.ref // empty' <<< "$payload")
          head_repo=$(jq -r '.pull_requests[0].head.repo.full_name // empty' <<< "$payload")

          if [ -z "$pr" ]; then
            echo "No PR found on workflow_run payload; exiting."
            exit 1
          fi

          {
            echo "pr=$pr"
            echo "head_ref=$head_ref"
            echo "head_repo=$head_repo"
          } >> "$GITHUB_OUTPUT"

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Pull bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST: ${{ steps.pr.outputs.pr }}
        run: brew pr-pull --debug --tap="$GITHUB_REPOSITORY" "$PULL_REQUEST"

      - name: Detect bottle changes
        id: changes
        run: |
          git status --short
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit bottle changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git add .
          git commit -m "Auto bottle updates for PR #${{ steps.pr.outputs.pr }}"

      - name: Sanitize git auth for PR creation
        if: steps.changes.outputs.changed == 'true'
        run: |
          git remote set-url origin "https://github.com/${GITHUB_REPOSITORY}.git"
          git config --local --unset-all http.https://github.com/.extraheader || true

      - name: Create PR for bottles
        if: steps.changes.outputs.changed == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bottle-pr-${{ steps.pr.outputs.pr }}
          base: main
          title: Auto bottle updates for PR #${{ steps.pr.outputs.pr }}
          body: |
            Bottles built from PR #${{ steps.pr.outputs.pr }}.
            This PR was created automatically because direct pushes to main are blocked.
          labels: |
            automerge

      - name: Enable auto-merge for bottle PR
        if: steps.cpr.outputs.pull-request-number != ''
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
        with:
          script: |
            const pr = Number(process.env.PR_NUMBER);
            await github.rest.pulls.enableAutoMerge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr,
              merge_method: 'squash',
            });

      - name: Delete branch
        if: steps.changes.outputs.changed == 'true' && steps.pr.outputs.head_repo == github.repository && steps.pr.outputs.head_ref != ''
        env:
          BRANCH: ${{ steps.pr.outputs.head_ref }}
        run: git push --delete origin "$BRANCH"
